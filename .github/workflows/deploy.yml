name: Deploy Football Fixtures

on:
  # æ‰‹å‹•è§¸ç™¼
  workflow_dispatch:
  
  # å®šæ™‚è§¸ç™¼ï¼šæ¯6å°æ™‚é‹è¡Œä¸€æ¬¡
  schedule:
    - cron: '0 */6 * * *'
  
  # ä»£ç¢¼æŽ¨é€æ™‚è§¸ç™¼
  push:
    branches: [ main ]
  
  # æ‹‰å–è«‹æ±‚æ™‚è§¸ç™¼
  pull_request:
    branches: [ main ]

# ç’°å¢ƒè®Šé‡
env:
  PYTHON_VERSION: '3.9'
  NODE_VERSION: '18'

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: ðŸ“¥ æª¢å‡ºä»£ç¢¼
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # ç²å–å®Œæ•´æ­·å²
        
    - name: ðŸ è¨­ç½®Pythonç’°å¢ƒ
      uses: actions/setup-python@v5
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        
    - name: ðŸ“¦ å®‰è£Pythonä¾è³´
      run: |
        python -m pip install --upgrade pip
        pip install jinja2
        
    - name: ðŸ”§ æª¢æŸ¥æ•¸æ“šåº«æ–‡ä»¶
      run: |
        echo "æª¢æŸ¥æ•¸æ“šåº«æ–‡ä»¶..."
        if [ -f "data/fixtures.db" ]; then
          echo "âœ… æ‰¾åˆ°æœ¬åœ°æ•¸æ“šåº«æ–‡ä»¶"
          ls -la data/fixtures.db
        else
          echo "âš ï¸ æœªæ‰¾åˆ°æœ¬åœ°æ•¸æ“šåº«ï¼Œä½¿ç”¨APIåŒæ­¥æ¨¡å¼"
        fi
        
    - name: ðŸš€ é‹è¡Œéœæ…‹ç”Ÿæˆå™¨
      run: |
        echo "é–‹å§‹ç”Ÿæˆéœæ…‹ç¶²ç«™..."
        cd static_generator
        python html_builder.py --days 7
        cd ..
        
        # æª¢æŸ¥ç”Ÿæˆçš„æ–‡ä»¶
        echo "ç”Ÿæˆçš„æ–‡ä»¶:"
        find public -type f | head -20
        
    - name: ðŸ“Š ç”Ÿæˆéƒ¨ç½²å ±å‘Š
      run: |
        echo "ç”Ÿæˆéƒ¨ç½²å ±å‘Š..."
        cat > public/deployment-info.json << EOF
        {
          "deployment": {
            "status": "success",
            "timestamp": "$(date -u +'%Y-%m-%dT%H:%M:%SZ')",
            "trigger": "${{ github.event_name }}",
            "runner": "ubuntu-latest",
            "python_version": "${{ env.PYTHON_VERSION }}"
          },
          "files": {
            "total": "$(find public -type f | wc -l)",
            "html": "$(find public -name '*.html' | wc -l)",
            "json": "$(find public -name '*.json' | wc -l)",
            "css": "$(find public -name '*.css' | wc -l)",
            "js": "$(find public -name '*.js' | wc -l)"
          },
          "github": {
            "repository": "${{ github.repository }}",
            "ref": "${{ github.ref }}",
            "sha": "${{ github.sha }}",
            "run_id": "${{ github.run_id }}"
          }
        }
        EOF
        
    - name: ðŸš€ éƒ¨ç½²åˆ°GitHub Pages
      if: github.ref == 'refs/heads/main'
      uses: peaceiris/actions-gh-pages@v3
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        publish_dir: ./public
        publish_branch: gh-pages
        force_orphan: true
        user_name: 'github-actions[bot]'
        user_email: 'github-actions[bot]@users.noreply.github.com'
        
    - name: ðŸ“§ ç™¼é€éƒ¨ç½²é€šçŸ¥
      if: always()
      uses: actions/github-script@v6
      with:
        script: |
          const fs = require('fs');
          
          // è®€å–éƒ¨ç½²ä¿¡æ¯
          let deploymentInfo = {};
          try {
            deploymentInfo = JSON.parse(fs.readFileSync('public/deployment-info.json', 'utf8'));
          } catch (e) {
            deploymentInfo = { error: 'ç„¡æ³•è®€å–éƒ¨ç½²ä¿¡æ¯' };
          }
          
          // å‰µå»ºéƒ¨ç½²ç¸½çµ
          const summary = `
          ### ðŸš€ è¶³çƒè³½äº‹æ•¸æ“šä¸­å¿ƒéƒ¨ç½²å®Œæˆ
          
          **éƒ¨ç½²ç‹€æ…‹**: ${job.status === 'success' ? 'âœ… æˆåŠŸ' : 'âŒ å¤±æ•—'}
          **è§¸ç™¼æ–¹å¼**: ${github.event_name}
          **éƒ¨ç½²æ™‚é–“**: ${new Date().toISOString()}
          **Gitæäº¤**: ${github.sha.substring(0, 7)}
          
          **æ–‡ä»¶çµ±è¨ˆ**:
          - ç¸½æ–‡ä»¶æ•¸: ${deploymentInfo.files?.total || 'N/A'}
          - HTMLæ–‡ä»¶: ${deploymentInfo.files?.html || 'N/A'}
          - JSON API: ${deploymentInfo.files?.json || 'N/A'}
          
          **è¨ªå•åœ°å€**:
          - ðŸŒ ç¶²ç«™ä¸»é : https://daddypig4559-svg.github.io/football-fixtures/
          - ðŸ”— GitHubå€‰åº«: https://github.com/daddypig4559-svg/football-fixtures
          - ðŸ“Š JSON API: https://daddypig4559-svg.github.io/football-fixtures/api/fixtures.json
          
          **ä¸‹æ¬¡æ›´æ–°**: 6å°æ™‚å¾Œè‡ªå‹•æ›´æ–°
          `;
          
          // å‰µå»ºéƒ¨ç½²è©•è«–
          github.rest.issues.createComment({
            owner: context.repo.owner,
            repo: context.repo.repo,
            issue_number: context.issue.number || context.runId,
            body: summary
          });
          
    - name: ðŸŽ‰ éƒ¨ç½²å®Œæˆ
      if: success()
      run: |
        echo "ðŸŽ‰ éƒ¨ç½²æˆåŠŸå®Œæˆï¼"
        echo ""
        echo "ðŸŒ è¨ªå•åœ°å€:"
        echo "   https://daddypig4559-svg.github.io/football-fixtures/"
        echo ""
        echo "ðŸ“Š JSON API:"
        echo "   https://daddypig4559-svg.github.io/football-fixtures/api/fixtures.json"
        echo ""
        echo "â° ä¸‹æ¬¡è‡ªå‹•æ›´æ–°: 6å°æ™‚å¾Œ"
        
    - name: ðŸš¨ éƒ¨ç½²å¤±æ•—è™•ç†
      if: failure()
      run: |
        echo "âŒ éƒ¨ç½²å¤±æ•—ï¼"
        echo ""
        echo "è«‹æª¢æŸ¥ä»¥ä¸‹é …ç›®:"
        echo "1. ä»£ç¢¼èªžæ³•éŒ¯èª¤"
        echo "2. æ–‡ä»¶æ¬Šé™å•é¡Œ"
        echo "3. GitHub Tokenæ¬Šé™"
        echo "4. ç¶²çµ¡é€£æŽ¥å•é¡Œ"
        echo ""
        echo "æŸ¥çœ‹è©³ç´°éŒ¯èª¤æ—¥èªŒè«‹è¨ªå•Actionsé é¢"